# Azure Container Apps configuration for OpenSight
# Deploy using: az containerapp create -n opensight -g RESOURCE_GROUP --yaml containerapp.yaml

location: eastus
name: opensight
type: Microsoft.App/containerApps

properties:
  managedEnvironmentId: /subscriptions/SUBSCRIPTION_ID/resourceGroups/RESOURCE_GROUP/providers/Microsoft.App/managedEnvironments/ENVIRONMENT_NAME

  configuration:
    ingress:
      external: true
      targetPort: 7860
      transport: auto
      allowInsecure: false
      traffic:
        - latestRevision: true
          weight: 100

    registries: []

  template:
    containers:
      - name: opensight
        image: REGISTRY/opensight:latest
        resources:
          cpu: 1.0
          memory: 2Gi
        env:
          - name: PYTHONPATH
            value: src
          - name: LOG_LEVEL
            value: INFO
        probes:
          - type: Startup
            httpGet:
              path: /health
              port: 7860
            initialDelaySeconds: 10
            periodSeconds: 10
            failureThreshold: 3
          - type: Liveness
            httpGet:
              path: /health
              port: 7860
            periodSeconds: 30
            failureThreshold: 3
          - type: Readiness
            httpGet:
              path: /health
              port: 7860
            periodSeconds: 10
            failureThreshold: 3

    scale:
      minReplicas: 0
      maxReplicas: 10
      rules:
        - name: http-scaling
          http:
            metadata:
              concurrentRequests: '50'
