# 48-Hour Codebase Audit — Feb 9-11, 2026

**Scope:** 22 commits, 19 files changed, ~4,700 lines added, ~236 lines removed
**Period:** 2026-02-10 15:41 → 2026-02-10 22:02 CST
**Authors:** CS2 Analyzer Developer, nukethe02

---

## Executive Summary

The last 48 hours saw four major workstreams land on `master`:

| # | Workstream | Commits | Risk Level |
|---|-----------|---------|------------|
| 1 | **Pipeline bug fixes (Wave A + B)** | 5d4342a, 34a9c19, 441427a | LOW — Well-tested, fixes real bugs |
| 2 | **Testing & documentation infra** | 2c52642, 4286b07, 83c48db, 4acbbeb | LOW — Net positive for reliability |
| 3 | **Auth system overhaul** | f23370e, 443fafc, fabe2f8, 6083b2c, a899d0b, e5a4504 | **CRITICAL — Has crashing bugs** |
| 4 | **Monetization & UX** | f4852b9, 9de1b1d, 137add7, 48a035c, 609a9c0–17b78c5 | **HIGH — Security gaps, XSS vectors** |

**Verdict:** Workstreams 1-2 are solid. Workstreams 3-4 have **3 crashing bugs** and **5 security vulnerabilities** that must be fixed before any production deployment.

---

## Table of Contents

1. [Workstream 1: Pipeline Bug Fixes (Wave A + B)](#workstream-1-pipeline-bug-fixes)
2. [Workstream 2: Testing & Documentation Infrastructure](#workstream-2-testing--documentation-infrastructure)
3. [Workstream 3: Auth System Overhaul](#workstream-3-auth-system-overhaul)
4. [Workstream 4: Monetization & UX](#workstream-4-monetization--ux)
5. [Pipeline Serialization Changes](#pipeline-serialization-changes)
6. [Position Extraction System](#position-extraction-system)
7. [Critical Issues Summary](#critical-issues-summary)
8. [Security Vulnerability Summary](#security-vulnerability-summary)
9. [Recommendations](#recommendations)

---

## Workstream 1: Pipeline Bug Fixes

### Wave A — `5d4342a` (Feb 10, 15:41)

**Files:** `pipeline/orchestrator.py`, `static/index.html`

Four issues fixed:

#### Issue 5: Kill Matrix Missing SteamIDs
- **Before:** Kill matrix entries only had `attacker` and `victim` (names), no steamids
- **After:** Added `attacker_steamid` and `victim_steamid` fields to each entry
- **Impact:** Frontend `getMostKilledPlayer()` and `getMostDiedTo()` now work correctly
- **Location:** `orchestrator.py:1746-1790` — `_build_kill_matrix()`

#### Issues 7+8: Raw SteamIDs as Player Names
- **Before:** Kill event names could be raw SteamID strings (e.g., `"76561197960287930"`)
- **After:** All name fallbacks now go through `is_valid_player_name()` validation, generating `Player_XXXX` fallbacks for invalid names
- **Location:** `orchestrator.py:1746-1790` (`_build_kill_matrix`), `orchestrator.py:1846-1870` (`_collect_dry_peek_events`)

#### Issue 9: Coaching Best Trader Was Match-Level
- **Before:** Coaching insight "play closer to X for trades" referenced the match-wide best trader — which could be the player themselves or an opponent
- **After:** Finds best trader among the player's own teammates (excluding self)
- **Location:** `orchestrator.py:2512-2535`

#### Issue 10: Highlights Module Not Wired
- **Before:** `analysis/highlights.py` existed but was never called; frontend showed "Coming soon" placeholder
- **After:** `detect_highlights()` called in orchestrator pipeline, top 10 highlights serialized to output, frontend renders highlight cards with emoji icons, color-coding by type, and impact score bars
- **Location:** `orchestrator.py:310-365` (detection + serialization), `index.html:8061-8180` (`renderHighlights()`)

### Wave B — `34a9c19` (Feb 10, 16:01)

**Files:** `pipeline/orchestrator.py`, `analysis/compute_utility.py`, `static/index.html`

Four issues fixed:

#### Issue 1: TTD/CP None→0→Falsy Display Bug
- **Root Cause:** Backend serialized missing TTD/CP as `0`, JavaScript `if (value)` treated `0` as falsy → showed "N/A" for legitimate zero values
- **Fix (Backend):** Changed `else 0` to `else None` in 7 locations across `orchestrator.py:143-160`
- **Fix (Frontend):** Changed `adv.ttd ? ... : '-'` to `adv.ttd != null ? ... : 'N/A'` in `index.html:4448-4455`
- **Fix (Logic):** Added `if ttd is not None and ttd > 0` guards in coaching/rating code (11 locations in orchestrator)

#### Issue 2: Flash Assists at 0% (SteamID Mismatch)
- **Root Cause:** demoparser2 uses different steamid formats in kill events vs grenade events (only 10% match rate). Flash assist correlation was using steamid-based matching.
- **Fix:** Changed `compute_utility.py:495-538` from steamid-based to **name-based matching**. Uses `attacker_name`/`victim_name` columns for blind-kill correlation.
- **Key Change:** `kills_df[vic_col] == victim_id` → `kills_df[vic_name_col] == victim_name`

#### Issue 6: Timeline T-Side Missing Players
- **Root Cause:** Timeline used deprecated `player_teams` which doesn't handle halftime swaps
- **Fix:** Uses `player_persistent_teams` (roster identity) mapped through `team_starting_sides` dict for stable team assignment. Falls back to deprecated field only if new fields unavailable.
- **Location:** `orchestrator.py:1359-1380`

#### Issue 4: Multi-Kills Overcounting
- **Root Cause:** Same steamid mismatch issue as flash assists, plus unreliable `round_boundaries`
- **Fix:** Changed to name-based kill counting instead of steamid. Uses tick proximity for round inference. Maps back to steamids via `player_names` dict.
- **Location:** `orchestrator.py:1284-1340`

### Merge — `441427a` (Feb 10, 16:02)

Clean merge of Wave B into master.

---

## Workstream 2: Testing & Documentation Infrastructure

### E2E Pipeline Test — `2c52642` (Feb 10, 16:18)

**File:** `tests/test_e2e_pipeline.py` (706 lines, new file)

Three-layer validation:

1. **TestSerializationCompleteness** — Reads `PlayerMatchStats` dataclass fields, verifies each appears in orchestrator output. Documents 40+ intentionally-unserialized internal fields with rationale.
2. **TestFrontendKeyAlignment** — Parses `index.html` JavaScript for data access patterns (`player.stats.kills`, `adv.ttd_median_ms`, etc.), verifies backend produces every key the frontend reads.
3. **TestPipelineDataFlow** — Runs a golden master demo through the full pipeline, checks non-null field coverage, validates no raw SteamIDs in output, verifies timeline has both CT/T data.

**Pipeline Smoke Test** — `scripts/pipeline_smoke_test.py` (299 lines, new file)

Quick CLI tool for developers: runs a demo through the pipeline, shows colored table of field coverage (PASS/PARTIAL/FAIL). Checks name resolution, timeline integrity, and highlights detection.

### Serialization Contract — `4286b07` (Feb 10, 16:30)

**File:** `docs/SERIALIZATION_CONTRACT.md` (559 lines, new file)

Single source of truth for the data pipeline: maps every `PlayerMatchStats` field to its orchestrator output key and frontend access path. Documents 5 major serialization gaps (SideStats, MistakesStats, LurkStats, opening duel zones, impact_plus_minus). Includes step-by-step guide for adding new fields.

### CLAUDE.md Updates — `83c48db` (Feb 10, 16:37)

Added 316 lines to CLAUDE.md:
- Pipeline Wiring Checklist (8-step mandatory checklist for new metrics)
- Serialization Rules (None vs 0, contract-first development)
- SteamID Handling Rules (name-based matching, demoparser2 quirks)
- Name Resolution Rules (canonical names from player_names dict)
- Deprecated Field Migration process
- Testing Requirements (mandatory tests before commit)
- Known demoparser2 Quirks (team numbers, position data availability, flash assist detection)

### xfail Markers — `4acbbeb` (Feb 10, 16:39) and `97f4b08` (Feb 10, 20:26)

- First commit marked known-failing tests as `@pytest.mark.xfail` to unblock CI/CD
- Second commit removed the xfail markers after the TTD and timeline bugs were actually fixed in Wave B

---

## Workstream 3: Auth System Overhaul

### Tier Fix — `f23370e` (Feb 10, 19:41)

**File:** `auth/tiers.py`

Set `ai_enabled=True` and `scouting_enabled=True` for the PRO tier. Previously both were `False`, meaning PRO users couldn't access AI coaching or scouting — the two key features they were paying for.

### Database User Model — `443fafc` (Feb 10, 19:47)

**File:** `infra/database.py` (+148 lines)

Added SQLAlchemy `User` model with columns:
- `id`, `email` (unique), `username`, `password_hash`
- `steam_id` (nullable, for Steam-linked accounts)
- `tier` (string: "free"/"pro"/"team"/"admin")
- `avatar_url`, `created_at`, `last_login`
- `to_dict()` method (correctly excludes `password_hash`)

Added helper functions: `create_user()`, `get_user_by_email()`, `get_user_by_steam_id()`, `get_user_by_id()`, `update_user_tier()`, `get_session()`.

### DB-Backed Auth — `fabe2f8` (Feb 10, 19:51)

**File:** `api/routes_auth.py` (rewritten, 230 lines)

Replaced in-memory auth with database-backed registration and login:
- `POST /auth/register` — Creates user with bcrypt-hashed password, returns JWT
- `POST /auth/login` — Validates credentials, returns JWT
- `GET /auth/me` — Decodes JWT, returns user profile
- `POST /auth/verify-token` — Validates JWT without side effects

Password hashing uses `bcrypt` via `auth/passwords.py`. JWT uses `python-jose` HS256 with 24-hour expiry.

### Steam OpenID Module — `6083b2c` (Feb 10, 20:44)

**File:** `auth/steam.py` (193 lines, new file)

Implements Steam OpenID 2.0 authentication:
- `build_auth_url()` — Generates Steam login redirect URL
- `validate_response()` — Validates OpenID response with `check_authentication` call to Steam
- `get_player_summary()` — Fetches display name and avatar from Steam API (optional, requires `STEAM_API_KEY`)

Implementation is solid: proper OpenID validation, 17-digit regex on claimed_id, 10-second HTTP timeout, graceful fallback if Steam API key not set.

### Steam Routes — `a899d0b` (Feb 10, 20:48)

**File:** `api/routes_steam.py` (168 lines, new file)

Endpoints:
- `GET /auth/steam/login` — Redirects to Steam OpenID
- `GET /auth/steam/callback` — Handles Steam response, creates/updates user, returns JWT via redirect
- `GET /auth/steam/status` — Reports if Steam auth is configured

### Steam Router Registration — `e5a4504` (Feb 10, 20:51)

**File:** `api/__init__.py`

Added `from opensight.api.routes_steam import router as steam_router` and `app.include_router(steam_router)`.

### **CRITICAL BUGS in Steam Routes (`routes_steam.py`)**

| Bug | Severity | Line | Description |
|-----|----------|------|-------------|
| `get_session_context()` doesn't exist | **CRASH** | 90 | Function not defined anywhere in codebase. All Steam logins will fail with `ImportError`. Should use `get_session()` from database.py |
| `create_access_token()` wrong signature | **CRASH** | 131-135 | Passes a dict `{user_id, email, steam_id}` but `jwt.py:create_access_token()` takes `(user_id: int, email: str)` positional args. Will crash with `TypeError` |
| JWT token leaked in URL | **HIGH** | 147-157 | Token passed as query parameter `/?auth_success=1&token=eyJ...` — visible in browser history, server logs, referrer headers |
| Duplicate username collision | **MEDIUM** | 85 | Fallback name `Player_{steam_id[-4:]}` can collide across different Steam accounts |
| Double-create on conflict | **MEDIUM** | 96-122 | If first `create_user()` fails, tries again with suffix — no rollback between attempts, could leave corrupted records |

---

## Workstream 4: Monetization & UX

### Pipeline Serialization Additions — `609a9c0`, `ef7ad43` (Feb 10, 19:58-20:04)

**Files:** `pipeline/contract.py` (new), `pipeline/orchestrator.py`

Added serialization for previously-computed but unexposed metrics:
- **Side stats** (CT/T breakdown): kills, deaths, assists, damage, rounds played per side
- **Mistakes**: team kills, team damage, teammates flashed
- **Lurk stats**: lurk rounds, lurk kills, lurk deaths, lurk success rate
- **Clutch attempts**: total situations, success percentage

**Contract module** (`pipeline/contract.py`, 39 lines) defines expected output shape with type annotations and a `validate_result()` function.

### **CRITICAL: Orchestrator Accesses Non-Existent Fields**

| Field Access | Location | Problem |
|-------------|----------|---------|
| `p.mistakes.self_flashes` | orchestrator.py:298 | `MistakesStats` has no `self_flashes` field — will crash with `AttributeError` |
| `p.lurk.lurk_success_rate` | orchestrator.py:304 | `LurkStats` has no `lurk_success_rate` property — will crash |
| `p.lurk.lurk_rounds` | orchestrator.py:301 | Field is actually `rounds_lurking` on `LurkStats` — wrong name |
| `p.ct_stats.rounds_won` | orchestrator.py:283 | `SideStats` has no `rounds_won` field — will crash |
| `p.t_stats.rounds_won` | orchestrator.py:291 | Same issue for T side |

These will crash at runtime when any match has mistakes/lurk/side data. They are wrapped in `if p.mistakes else 0` guards, so they won't crash if the nested object is `None` — but they WILL crash if the object exists (which it does for most matches).

### TTD/CP Fix — `23583b9`, `27a2ffd` (Feb 10, 20:12-20:23)

- Normalized team sides handling (int↔str conversion) in round_scores
- Added `ct_kills`/`t_kills` fields to round score entries
- Fixed TTD computation to properly calculate `ttd_median_ms` and `ttd_mean_ms` from engagement duration values

### Position Extraction — `91958fa`, `804bdfc` (Feb 10, 20:32-20:40)

**File:** `analysis/positioning_data.py` (545 lines, new file)

Five extraction categories:
1. **Death positions** — Where players die (victim x,y,z)
2. **Engagement positions** — Where players get kills (attacker x,y,z)
3. **Defensive setups** — CT positions at freeze-time end (team 3 only)
4. **Grenade landings** — Utility impact locations
5. **Firing velocity** — Player speed at moment of shot

Each position annotated with metadata (weapon, round, tick, zone callout). Output aggregated into `PlayerPositionStats` with zone frequency breakdowns.

**Integration:** Wired into orchestrator at `orchestrator.py` — position data extracted and included in output JSON.

**Note:** Zone frequency data is computed but the frontend (`coach-ux.js`) only displays basic zone cards, not the full heatmap data. This is partial integration — the heavy computation runs but most results aren't visible to users yet.

### Paddle Webhook — `f4852b9` (Feb 10, 21:37)

**File:** `api/routes_paddle.py` (155 lines, new file)

Handles Paddle subscription lifecycle events:

| Event | Action |
|-------|--------|
| `subscription.created` | Upgrade user tier |
| `subscription.updated` | Change tier based on plan |
| `subscription.canceled` | Downgrade to FREE |
| `subscription.paused` | Downgrade to FREE |
| `subscription.resumed` | Restore tier |

### **CRITICAL: Paddle Webhook Security Bypass**

```python
def verify_paddle_signature(raw_body: bytes, signature: str) -> bool:
    if not PADDLE_WEBHOOK_SECRET:
        logger.warning("PADDLE_WEBHOOK_SECRET not set -- skipping verification")
        return True  # ACCEPTS UNSIGNED WEBHOOKS
```

If `PADDLE_WEBHOOK_SECRET` is not set (which it won't be in most environments), **any HTTP client can send fake webhook events to upgrade/downgrade user tiers without payment**. This is a critical security bypass.

Additionally:
- `PLAN_TO_TIER` maps to `Tier.PLUS` which doesn't exist (only FREE/PRO/TEAM/ADMIN)
- If signature header is omitted, verification is skipped even when secret IS set
- Race condition possible with concurrent webhook delivery

### Landing Page — `137add7` (Feb 10, 21:33)

**File:** `static/landing.html` (613 lines, new file)

Marketing landing page with:
- Hero section with animated demo counter
- 6 feature cards (Instant Analysis, AI Coaching, etc.)
- 3 pricing tiers (Free, Plus $4.99/mo, Pro $9.99/mo)
- Comparison table (OpenSight vs Leetify vs Scope.gg)
- Steam auth callback handler (stores JWT in localStorage)
- Paddle.js integration for payment processing

### Route Changes — `48a035c` (Feb 10, 21:45)

**File:** `api/__init__.py`

- `GET /` now serves `landing.html` (marketing page)
- `GET /analyze` serves `index.html` (analyzer interface)
- Previous behavior was `GET /` serving the analyzer directly

### Coach UX — `9d6a702`, `17b78c5` (Feb 10, 21:57-22:02)

**File:** `static/js/coach-ux.js` (336 lines, new file)

Tabbed interface overlay for match results:
- **Overview tab** — Existing match results content
- **Performance tab** — Canvas radar chart (6 axes: Aim, Impact, Utility, Trade, Survival, Economy) + CT/T side comparison
- **AI Coach tab** — Coaching insights with color-coded cards (positive/negative/neutral)
- **Positions tab** — Zone intelligence cards (kills, deaths, K/D per zone)

Auto-initializes via IIFE, listens for `opensight:results` custom event from `index.html`.

---

## Critical Issues Summary

### Crashing Bugs (Will Fail at Runtime)

| # | Location | Issue | Impact |
|---|----------|-------|--------|
| 1 | `routes_steam.py:90` | `get_session_context()` not defined | **All Steam logins crash** |
| 2 | `routes_steam.py:131-135` | `create_access_token()` wrong call signature | **Steam JWT creation crashes** |
| 3 | `orchestrator.py:298` | `MistakesStats.self_flashes` doesn't exist | **Crashes when mistakes data present** |
| 4 | `orchestrator.py:301,304` | `LurkStats.lurk_rounds`/`lurk_success_rate` don't exist | **Crashes when lurk data present** |
| 5 | `orchestrator.py:283,291` | `SideStats.rounds_won` doesn't exist | **Crashes when side stats present** |

Bugs 3-5 are guarded by `if p.mistakes else 0` / `if p.lurk else None` / `if p.ct_stats else 0`, so they only crash when the compute modules actually populate these objects. If the compute modules currently return `None` for these fields, the crashes are deferred — but they will manifest as soon as real demo data triggers the code paths.

### Data Integrity Issues

| # | Location | Issue |
|---|----------|-------|
| 1 | `orchestrator.py:231,234` | `aim_stats` section still uses `else 0` for TTD/CP (Wave B fixed `advanced` section but not `aim_stats`) |
| 2 | `routes_paddle.py:55-58` | `PLAN_TO_TIER` maps to `Tier.PLUS` which doesn't exist in the enum |
| 3 | `auth/tiers.py` | `check_tier()` defined but never called — no tier enforcement on any endpoint |

---

## Security Vulnerability Summary

| # | Severity | Location | Vulnerability | Fix |
|---|----------|----------|---------------|-----|
| 1 | **CRITICAL** | `routes_paddle.py:31-32` | Webhook signature verification skipped if env var not set — allows unauthorized tier changes | Reject webhooks when secret not configured |
| 2 | **HIGH** | `routes_steam.py:147-157` | JWT token leaked in URL query parameter — logged in browser history, server access logs, referrer headers | Use URL fragment (`#token=`) or httpOnly cookie |
| 3 | **HIGH** | `coach-ux.js:232-234` | HTML injection in coaching insights — `insight.title` and `insight.message` inserted without escaping | Use `escapeHtml()` or `textContent` |
| 4 | **HIGH** | `coach-ux.js:266` | HTML injection in zone names — `z.name` inserted without escaping | Same fix |
| 5 | **HIGH** | `landing.html:562-570` | XSS in Steam auth callback — `username` and `avatar` URL params stored in localStorage without sanitization | Validate/sanitize before storing |
| 6 | **MEDIUM** | `routes_auth.py` | No rate limiting on login/register endpoints — brute-force possible | Add `@rate_limit` decorator |
| 7 | **MEDIUM** | `api/__init__.py:194` | CSP missing `paddle.com` — Paddle.js will be blocked by browser CSP | Add `https://cdn.paddle.com` to script-src |
| 8 | **MEDIUM** | `api/__init__.py:64-79` | Wildcard CORS `https://*.hf.space` allows any HF Space to call the API | Restrict to specific Space URL |
| 9 | **LOW** | `auth/jwt.py` | No token blacklist/revocation — compromised token valid for full 24 hours | Add logout endpoint + token blacklist |

---

## Recommendations

### Immediate (Block Deployment)

1. **Fix Steam auth crashes** — Replace `get_session_context()` with `get_session()`, fix `create_access_token()` call signature
2. **Fix Paddle webhook bypass** — Reject webhooks when `PADDLE_WEBHOOK_SECRET` not set, enforce signature check when header is present
3. **Fix orchestrator AttributeErrors** — Either add missing fields to dataclasses (`self_flashes`, `lurk_success_rate`, `rounds_won`) or remove from serialization output
4. **Fix remaining TTD/CP `else 0`** in `aim_stats` section (orchestrator.py:231,234)
5. **Add HTML escaping** in `coach-ux.js` for all user-controlled data

### High Priority (This Sprint)

6. **Add rate limiting** to `/auth/register` and `/auth/login`
7. **Move JWT out of URL** — use fragment or httpOnly cookie for Steam callback
8. **Add `paddle.com` to CSP** — or Paddle.js won't load
9. **Enforce tier checks** — `check_tier()` exists but is never called on any endpoint
10. **Fix `PLAN_TO_TIER` mapping** — Replace `Tier.PLUS` with valid tier values

### Medium Priority (Next Sprint)

11. Add password reset flow (no mechanism exists today)
12. Add email verification
13. Implement JWT refresh tokens (reduce 24h expiry)
14. Restrict CORS to specific HF Space URL
15. Wire position zone data to frontend (computed but not displayed)
16. Add SRI hashes to CDN resources (jsdelivr, fonts.googleapis.com)

---

## Commit-by-Commit Reference

| Time (CST) | Hash | Category | Summary |
|------------|------|----------|---------|
| 15:41 | `5d4342a` | Bug Fix | Wave A: kill matrix steamids, name resolution, coaching, highlights |
| 16:01 | `34a9c19` | Bug Fix | Wave B: TTD/CP null handling, flash assists, timeline teams, multi-kills |
| 16:02 | `441427a` | Merge | Merge Wave B into master |
| 16:18 | `2c52642` | Testing | E2E pipeline test + smoke test script |
| 16:30 | `4286b07` | Docs | Serialization contract document |
| 16:37 | `83c48db` | Docs | Pipeline wiring checklist + rules added to CLAUDE.md |
| 16:39 | `4acbbeb` | Testing | Mark known-failing tests as xfail |
| 19:41 | `f23370e` | Auth | Enable AI + scouting for PRO tier |
| 19:47 | `443fafc` | Auth | Add User model + DB helpers |
| 19:51 | `fabe2f8` | Auth | Replace in-memory auth with DB-backed |
| 19:58 | `609a9c0` | Pipeline | Contract schema for side_stats, mistakes, lurk, clutch attempts |
| 20:04 | `ef7ad43` | Pipeline | Wire side_stats, mistakes, lurk, clutch attempts serialization |
| 20:12 | `23583b9` | Pipeline | Normalize team sides, add ct_kills/t_kills to round_scores |
| 20:23 | `27a2ffd` | Bug Fix | Fix TTD computation from engagement values |
| 20:26 | `97f4b08` | Testing | Remove xfail markers (bugs now fixed) |
| 20:32 | `91958fa` | Feature | Position coordinate extraction system |
| 20:40 | `804bdfc` | Pipeline | Wire position extraction into orchestrator |
| 20:44 | `6083b2c` | Auth | Steam OpenID 2.0 module |
| 20:48 | `a899d0b` | Auth | Steam login/callback routes |
| 20:51 | `e5a4504` | Auth | Register Steam router in app |
| 21:33 | `137add7` | Feature | Landing page with pricing and Steam auth |
| 21:37 | `f4852b9` | Feature | Paddle webhook endpoint |
| 21:42 | `9de1b1d` | Feature | Register Paddle router in app |
| 21:45 | `48a035c` | Feature | Serve landing at /, analyzer at /analyze |
| 21:57 | `9d6a702` | Feature | 60-second coach UX (tabs, radar chart, AI coaching) |
| 22:02 | `17b78c5` | Feature | Add coach-ux.js script tag to index.html |

---

*Generated: 2026-02-11 by automated audit*
