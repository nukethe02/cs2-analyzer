<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenSight - CS2 Demo Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom scrollbar for dark mode */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Drag and drop highlight */
        .drop-zone.drag-over { border-color: #3b82f6; background-color: rgba(59, 130, 246, 0.1); }

        /* Tab transitions */
        .tab-content { display: none; animation: fadeIn 0.2s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Loading spinner */
        .spinner { border: 3px solid #475569; border-top: 3px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Stat card hover effect */
        .stat-card { transition: transform 0.2s, box-shadow 0.2s; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3); }

        /* Monospace for numbers */
        .font-mono-num { font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace; }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 font-sans">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <nav class="w-64 bg-slate-800 border-r border-slate-700 flex flex-col">
            <!-- Logo -->
            <div class="p-6 border-b border-slate-700">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-400 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-white">OpenSight</h1>
                        <p class="text-xs text-slate-400">CS2 Demo Analyzer</p>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="flex-1 p-4 space-y-2">
                <button id="nav-overview" class="nav-btn active w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <span>Overview</span>
                </button>
                <button id="nav-advanced" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    <span>Advanced</span>
                </button>
                <button id="nav-compare" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <span>Compare</span>
                </button>
                <button id="nav-weapons" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                    </svg>
                    <span>Weapons</span>
                </button>
            </div>

            <!-- Footer -->
            <div class="p-4 border-t border-slate-700">
                <div class="text-xs text-slate-500">
                    <p>OpenSight v1.0</p>
                    <p class="mt-1">Professional CS2 Analytics</p>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto">
            <!-- Upload Section (shown when no data) -->
            <div id="upload-section" class="h-full flex items-center justify-center p-6">
                <div class="w-full max-w-2xl">
                    <div id="drop-zone" class="drop-zone border-2 border-dashed border-slate-600 rounded-xl p-12 text-center cursor-pointer hover:border-slate-500 transition-colors">
                        <div class="mb-6">
                            <svg class="w-16 h-16 mx-auto text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                        </div>
                        <h2 class="text-2xl font-semibold text-white mb-2">Upload Demo File</h2>
                        <p class="text-slate-400 mb-6">Drag and drop your .dem or .dem.gz file here</p>
                        <input type="file" id="file-input" class="hidden" accept=".dem,.dem.gz">
                        <button id="browse-btn" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors">
                            Browse Files
                        </button>
                        <p class="text-xs text-slate-500 mt-4">Supports Valve MM, FACEIT, ESEA, and POV demos (max 500MB)</p>
                    </div>

                    <!-- Share Code Decode -->
                    <div class="mt-6 p-6 bg-slate-800 rounded-xl">
                        <h3 class="text-lg font-semibold text-white mb-3">Or Decode Share Code</h3>
                        <div class="flex gap-3">
                            <input type="text" id="sharecode-input" placeholder="CSGO-xxxxx-xxxxx-xxxxx-xxxxx-xxxxx"
                                   class="flex-1 px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-blue-500">
                            <button id="decode-btn" class="px-6 py-2 bg-slate-600 hover:bg-slate-500 text-white font-medium rounded-lg transition-colors">
                                Decode
                            </button>
                        </div>
                        <div id="decode-result" class="mt-3 text-sm hidden"></div>
                    </div>
                </div>
            </div>

            <!-- Loading Overlay -->
            <div id="loading-overlay" class="hidden fixed inset-0 bg-slate-900/80 flex items-center justify-center z-50">
                <div class="text-center">
                    <div class="spinner mx-auto mb-4"></div>
                    <p class="text-lg font-medium">Analyzing Demo...</p>
                    <p class="text-sm text-slate-400 mt-1">This may take a moment</p>
                </div>
            </div>

            <!-- Dashboard Content (shown after analysis) -->
            <div id="dashboard-content" class="hidden p-6">
                <!-- Match Header -->
                <div id="match-header" class="mb-6 p-6 bg-slate-800 rounded-xl">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold text-white" id="map-name">de_dust2</h2>
                            <p class="text-slate-400 mt-1">
                                <span id="match-score" class="text-lg font-semibold">13 - 16</span>
                                <span class="mx-2">|</span>
                                <span id="match-rounds">29 rounds</span>
                                <span class="mx-2">|</span>
                                <span id="tick-rate">64 tick</span>
                            </p>
                        </div>
                        <button id="new-analysis-btn" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                            </svg>
                            New Analysis
                        </button>
                    </div>
                </div>

                <!-- Tab Contents -->
                <!-- Overview Tab -->
                <div id="tab-overview" class="tab-content active">
                    <div class="bg-slate-800 rounded-xl overflow-hidden">
                        <div class="px-6 py-4 border-b border-slate-700">
                            <h3 class="text-lg font-semibold text-white">Player Statistics</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="bg-slate-700/50 text-left text-sm text-slate-300">
                                        <th class="px-6 py-3 font-semibold">Player</th>
                                        <th class="px-6 py-3 font-semibold text-center">Team</th>
                                        <th class="px-6 py-3 font-semibold text-center">K</th>
                                        <th class="px-6 py-3 font-semibold text-center">D</th>
                                        <th class="px-6 py-3 font-semibold text-center">A</th>
                                        <th class="px-6 py-3 font-semibold text-center">+/-</th>
                                        <th class="px-6 py-3 font-semibold text-center">ADR</th>
                                        <th class="px-6 py-3 font-semibold text-center">HS%</th>
                                        <th class="px-6 py-3 font-semibold text-center">KAST</th>
                                        <th class="px-6 py-3 font-semibold text-center">Rating</th>
                                    </tr>
                                </thead>
                                <tbody id="players-table" class="divide-y divide-slate-700">
                                    <!-- Player rows populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Kill Matrix -->
                    <div class="mt-6 bg-slate-800 rounded-xl overflow-hidden">
                        <div class="px-6 py-4 border-b border-slate-700">
                            <h3 class="text-lg font-semibold text-white">Kill Matrix</h3>
                            <p class="text-sm text-slate-400 mt-1">Who killed whom (rows = attackers, columns = victims)</p>
                        </div>
                        <div class="overflow-x-auto p-6">
                            <div id="kill-matrix-container">
                                <!-- Kill matrix populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Advanced Tab -->
                <div id="tab-advanced" class="tab-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="advanced-cards">
                        <!-- Player cards populated by JS -->
                    </div>
                </div>

                <!-- Compare Tab -->
                <div id="tab-compare" class="tab-content">
                    <div class="bg-slate-800 rounded-xl p-6">
                        <!-- Player Selection -->
                        <div class="flex flex-wrap gap-4 mb-6">
                            <div class="flex-1 min-w-[200px]">
                                <label class="block text-sm font-medium text-slate-300 mb-2">Player A</label>
                                <select id="player-a-select" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-blue-500">
                                    <!-- Options populated by JS -->
                                </select>
                            </div>
                            <div class="flex items-end pb-2">
                                <span class="text-slate-400 font-medium">vs</span>
                            </div>
                            <div class="flex-1 min-w-[200px]">
                                <label class="block text-sm font-medium text-slate-300 mb-2">Player B</label>
                                <select id="player-b-select" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-blue-500">
                                    <!-- Options populated by JS -->
                                </select>
                            </div>
                        </div>

                        <!-- Radar Chart -->
                        <div class="flex justify-center">
                            <div class="w-full max-w-2xl aspect-square">
                                <canvas id="compare-chart"></canvas>
                            </div>
                        </div>

                        <!-- Comparison Stats -->
                        <div class="mt-6 grid grid-cols-2 gap-4" id="comparison-stats">
                            <!-- Stats populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Weapons Tab -->
                <div id="tab-weapons" class="tab-content">
                    <div class="bg-slate-800 rounded-xl p-6">
                        <!-- Player Selection -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-slate-300 mb-2">Select Player</label>
                            <select id="weapons-player-select" class="w-full max-w-md px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-blue-500">
                                <!-- Options populated by JS -->
                            </select>
                        </div>

                        <!-- Weapons Table -->
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="bg-slate-700/50 text-left text-sm text-slate-300">
                                        <th class="px-6 py-3 font-semibold">Weapon</th>
                                        <th class="px-6 py-3 font-semibold text-center">Kills</th>
                                        <th class="px-6 py-3 font-semibold text-center">HS%</th>
                                        <th class="px-6 py-3 font-semibold text-center">Damage</th>
                                        <th class="px-6 py-3 font-semibold text-center">Shots</th>
                                        <th class="px-6 py-3 font-semibold text-center">Accuracy</th>
                                    </tr>
                                </thead>
                                <tbody id="weapons-table" class="divide-y divide-slate-700">
                                    <!-- Weapon rows populated by JS -->
                                </tbody>
                            </table>
                        </div>

                        <!-- No Data Message -->
                        <div id="weapons-no-data" class="hidden text-center py-8 text-slate-400">
                            <p>No weapon data available for this player</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // =============================================================================
        // Global State
        // =============================================================================
        let currentMatchData = null;
        let radarChart = null;

        // =============================================================================
        // DOM Elements
        // =============================================================================
        const uploadSection = document.getElementById('upload-section');
        const dashboardContent = document.getElementById('dashboard-content');
        const loadingOverlay = document.getElementById('loading-overlay');
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const browseBtn = document.getElementById('browse-btn');
        const sharecodeInput = document.getElementById('sharecode-input');
        const decodeBtn = document.getElementById('decode-btn');
        const decodeResult = document.getElementById('decode-result');
        const newAnalysisBtn = document.getElementById('new-analysis-btn');

        // Navigation buttons
        const navBtns = {
            overview: document.getElementById('nav-overview'),
            advanced: document.getElementById('nav-advanced'),
            compare: document.getElementById('nav-compare'),
            weapons: document.getElementById('nav-weapons')
        };

        // Tab contents
        const tabContents = {
            overview: document.getElementById('tab-overview'),
            advanced: document.getElementById('tab-advanced'),
            compare: document.getElementById('tab-compare'),
            weapons: document.getElementById('tab-weapons')
        };

        // =============================================================================
        // Utility Functions
        // =============================================================================
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatNumber(num, decimals = 1) {
            if (num === null || num === undefined) return 'N/A';
            return Number(num).toFixed(decimals);
        }

        function getRatingColor(rating) {
            if (rating >= 1.3) return 'text-green-400';
            if (rating >= 1.1) return 'text-emerald-400';
            if (rating >= 0.9) return 'text-yellow-400';
            if (rating >= 0.7) return 'text-orange-400';
            return 'text-red-400';
        }

        function getTeamBadge(team) {
            if (team === 'CT') {
                return '<span class="px-2 py-1 text-xs font-semibold rounded bg-blue-500/20 text-blue-400">CT</span>';
            } else {
                return '<span class="px-2 py-1 text-xs font-semibold rounded bg-yellow-500/20 text-yellow-400">T</span>';
            }
        }

        function getTierBadge(value, thresholds, labels, inverse = false) {
            let tier, color;
            if (inverse) {
                if (value <= thresholds[0]) { tier = labels[0]; color = 'bg-green-500/20 text-green-400'; }
                else if (value <= thresholds[1]) { tier = labels[1]; color = 'bg-emerald-500/20 text-emerald-400'; }
                else if (value <= thresholds[2]) { tier = labels[2]; color = 'bg-yellow-500/20 text-yellow-400'; }
                else { tier = labels[3]; color = 'bg-red-500/20 text-red-400'; }
            } else {
                if (value >= thresholds[0]) { tier = labels[0]; color = 'bg-green-500/20 text-green-400'; }
                else if (value >= thresholds[1]) { tier = labels[1]; color = 'bg-emerald-500/20 text-emerald-400'; }
                else if (value >= thresholds[2]) { tier = labels[2]; color = 'bg-yellow-500/20 text-yellow-400'; }
                else { tier = labels[3]; color = 'bg-red-500/20 text-red-400'; }
            }
            return `<span class="px-2 py-1 text-xs font-semibold rounded ${color}">${tier}</span>`;
        }

        // =============================================================================
        // Navigation
        // =============================================================================
        function switchTab(tabName) {
            // Update nav buttons
            Object.keys(navBtns).forEach(key => {
                navBtns[key].classList.remove('active', 'bg-slate-700', 'text-white');
                navBtns[key].classList.add('text-slate-400', 'hover:bg-slate-700/50', 'hover:text-white');
            });
            navBtns[tabName].classList.add('active', 'bg-slate-700', 'text-white');
            navBtns[tabName].classList.remove('text-slate-400', 'hover:bg-slate-700/50', 'hover:text-white');

            // Update tab contents
            Object.keys(tabContents).forEach(key => {
                tabContents[key].classList.remove('active');
            });
            tabContents[tabName].classList.add('active');

            // Re-render compare chart if switching to compare tab
            if (tabName === 'compare' && currentMatchData) {
                setTimeout(() => renderCompare(), 100);
            }
        }

        // Add event listeners to nav buttons
        Object.keys(navBtns).forEach(key => {
            navBtns[key].addEventListener('click', () => switchTab(key));
        });

        // Initialize nav button styles
        switchTab('overview');

        // =============================================================================
        // File Upload
        // =============================================================================
        browseBtn.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                uploadFile(e.target.files[0]);
            }
        });

        // Drag and drop
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) {
                uploadFile(e.dataTransfer.files[0]);
            }
        });

        async function uploadFile(file) {
            // Validate file
            const validExtensions = ['.dem', '.dem.gz'];
            const fileName = file.name.toLowerCase();
            if (!validExtensions.some(ext => fileName.endsWith(ext))) {
                alert('Please upload a .dem or .dem.gz file');
                return;
            }

            if (file.size > 500 * 1024 * 1024) {
                alert('File size exceeds 500MB limit');
                return;
            }

            // Show loading
            loadingOverlay.classList.remove('hidden');

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Analysis failed');
                }

                currentMatchData = await response.json();
                showDashboard();
            } catch (error) {
                alert('Error analyzing demo: ' + error.message);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        // =============================================================================
        // Share Code Decode
        // =============================================================================
        decodeBtn.addEventListener('click', async () => {
            const code = sharecodeInput.value.trim();
            if (!code) return;

            try {
                const response = await fetch('/decode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });

                const data = await response.json();
                decodeResult.classList.remove('hidden');

                if (response.ok) {
                    decodeResult.className = 'mt-3 text-sm p-3 bg-slate-700 rounded-lg';
                    decodeResult.innerHTML = `
                        <p class="text-green-400 font-semibold mb-2">Decoded Successfully</p>
                        <p><span class="text-slate-400">Match ID:</span> <span class="font-mono-num">${escapeHtml(data.match_id || 'N/A')}</span></p>
                        <p><span class="text-slate-400">Outcome ID:</span> <span class="font-mono-num">${escapeHtml(data.outcome_id || 'N/A')}</span></p>
                        <p><span class="text-slate-400">Token:</span> <span class="font-mono-num">${escapeHtml(data.token || 'N/A')}</span></p>
                    `;
                } else {
                    decodeResult.className = 'mt-3 text-sm p-3 bg-red-900/30 rounded-lg text-red-400';
                    decodeResult.textContent = data.detail || 'Failed to decode share code';
                }
            } catch (error) {
                decodeResult.classList.remove('hidden');
                decodeResult.className = 'mt-3 text-sm p-3 bg-red-900/30 rounded-lg text-red-400';
                decodeResult.textContent = 'Error: ' + error.message;
            }
        });

        // =============================================================================
        // Dashboard Display
        // =============================================================================
        function showDashboard() {
            uploadSection.classList.add('hidden');
            dashboardContent.classList.remove('hidden');
            renderMatchHeader();
            renderOverview();
            renderAdvanced();
            populatePlayerSelects();
            populateWeaponsSelect();
        }

        newAnalysisBtn.addEventListener('click', () => {
            currentMatchData = null;
            dashboardContent.classList.add('hidden');
            uploadSection.classList.remove('hidden');
            fileInput.value = '';
        });

        // =============================================================================
        // Render Match Header
        // =============================================================================
        function renderMatchHeader() {
            const data = currentMatchData;
            document.getElementById('map-name').textContent = escapeHtml(data.map_name || 'Unknown Map');
            document.getElementById('match-score').textContent = `${data.team1_score || 0} - ${data.team2_score || 0}`;
            document.getElementById('match-rounds').textContent = `${data.total_rounds || 0} rounds`;
            document.getElementById('tick-rate').textContent = `${data.tick_rate || 64} tick`;
        }

        // =============================================================================
        // Render Overview Tab
        // =============================================================================
        function renderOverview() {
            const players = Object.values(currentMatchData.players || {});

            // Sort by rating descending
            players.sort((a, b) => (b.hltv_rating || 0) - (a.hltv_rating || 0));

            const tableBody = document.getElementById('players-table');
            tableBody.innerHTML = players.map((p, i) => {
                const kdDiff = (p.kills || 0) - (p.deaths || 0);
                const kdDiffClass = kdDiff > 0 ? 'text-green-400' : kdDiff < 0 ? 'text-red-400' : 'text-slate-400';
                const kdDiffStr = kdDiff > 0 ? `+${kdDiff}` : kdDiff.toString();
                const rowBg = i % 2 === 0 ? 'bg-slate-800' : 'bg-slate-800/50';

                return `
                    <tr class="${rowBg} hover:bg-slate-700/50 transition-colors">
                        <td class="px-6 py-4">
                            <span class="font-medium text-white">${escapeHtml(p.name || 'Unknown')}</span>
                        </td>
                        <td class="px-6 py-4 text-center">${getTeamBadge(p.team)}</td>
                        <td class="px-6 py-4 text-center font-mono-num">${p.kills || 0}</td>
                        <td class="px-6 py-4 text-center font-mono-num">${p.deaths || 0}</td>
                        <td class="px-6 py-4 text-center font-mono-num">${p.assists || 0}</td>
                        <td class="px-6 py-4 text-center font-mono-num ${kdDiffClass}">${kdDiffStr}</td>
                        <td class="px-6 py-4 text-center font-mono-num">${formatNumber(p.adr, 1)}</td>
                        <td class="px-6 py-4 text-center font-mono-num">${formatNumber(p.headshot_percentage, 0)}%</td>
                        <td class="px-6 py-4 text-center font-mono-num">${formatNumber(p.kast_percentage, 0)}%</td>
                        <td class="px-6 py-4 text-center">
                            <span class="font-mono-num font-semibold ${getRatingColor(p.hltv_rating || 0)}">${formatNumber(p.hltv_rating, 2)}</span>
                        </td>
                    </tr>
                `;
            }).join('');

            // Render kill matrix
            renderKillMatrix(players);
        }

        function renderKillMatrix(players) {
            const container = document.getElementById('kill-matrix-container');
            const killMatrix = currentMatchData.kill_matrix || [];

            if (players.length === 0) {
                container.innerHTML = '<p class="text-slate-400">No kill data available</p>';
                return;
            }

            // Build matrix lookup
            const matrixLookup = {};
            killMatrix.forEach(entry => {
                const key = `${entry.attacker_name}-${entry.victim_name}`;
                matrixLookup[key] = entry.count;
            });

            // Create table
            let html = '<table class="min-w-full text-sm">';

            // Header row
            html += '<thead><tr><th class="px-3 py-2 text-left text-slate-400 font-medium">Attacker \\ Victim</th>';
            players.forEach(p => {
                html += `<th class="px-3 py-2 text-center text-slate-300 font-medium">${escapeHtml(p.name?.substring(0, 10) || '?')}</th>`;
            });
            html += '</tr></thead><tbody>';

            // Data rows
            players.forEach((attacker, i) => {
                const rowBg = i % 2 === 0 ? 'bg-slate-700/30' : '';
                html += `<tr class="${rowBg}"><td class="px-3 py-2 text-slate-300 font-medium">${escapeHtml(attacker.name || 'Unknown')}</td>`;
                players.forEach(victim => {
                    const key = `${attacker.name}-${victim.name}`;
                    const count = matrixLookup[key] || 0;
                    const cellClass = attacker.name === victim.name ? 'bg-slate-600/30 text-slate-500' :
                                     count > 0 ? 'text-white' : 'text-slate-500';
                    html += `<td class="px-3 py-2 text-center font-mono-num ${cellClass}">${attacker.name === victim.name ? '-' : count}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // =============================================================================
        // Render Advanced Tab
        // =============================================================================
        function renderAdvanced() {
            const players = Object.values(currentMatchData.players || {});
            players.sort((a, b) => (b.hltv_rating || 0) - (a.hltv_rating || 0));

            const container = document.getElementById('advanced-cards');
            container.innerHTML = players.map(p => {
                const ttd = p.ttd_mean_ms;
                const cp = p.cp_median_error_deg;
                const openingWin = p.opening_duels?.win_rate || 0;
                const clutchWin = p.clutches?.win_rate || 0;
                const kast = p.kast_percentage || 0;

                // TTD Tier (lower is better)
                const ttdBadge = ttd !== null ? getTierBadge(ttd, [200, 350, 500], ['Elite', 'Good', 'Average', 'Slow'], true) : '<span class="text-slate-500">N/A</span>';

                // CP Tier (lower is better)
                const cpBadge = cp !== null ? getTierBadge(cp, [5, 15, 25], ['Elite', 'Good', 'Average', 'Needs Work'], true) : '<span class="text-slate-500">N/A</span>';

                return `
                    <div class="stat-card bg-slate-800 rounded-xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-semibold text-white">${escapeHtml(p.name || 'Unknown')}</h3>
                                <p class="text-sm text-slate-400">${getTeamBadge(p.team)} <span class="ml-2">${formatNumber(p.hltv_rating, 2)} Rating</span></p>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <!-- TTD -->
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-slate-400">Time to Damage</p>
                                    <p class="text-xl font-semibold font-mono-num text-white">${ttd !== null ? formatNumber(ttd, 0) + ' ms' : 'N/A'}</p>
                                </div>
                                ${ttdBadge}
                            </div>

                            <!-- Crosshair Placement -->
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-slate-400">Crosshair Placement</p>
                                    <p class="text-xl font-semibold font-mono-num text-white">${cp !== null ? formatNumber(cp, 1) + '°' : 'N/A'}</p>
                                </div>
                                ${cpBadge}
                            </div>

                            <!-- Opening Duels -->
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-slate-400">Opening Duel Win Rate</p>
                                    <p class="text-xl font-semibold font-mono-num text-white">${formatNumber(openingWin, 0)}%</p>
                                </div>
                                <div class="text-xs text-slate-400">
                                    ${p.opening_duels?.attempts || 0} duels
                                </div>
                            </div>

                            <!-- Clutches -->
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-slate-400">Clutch Win Rate</p>
                                    <p class="text-xl font-semibold font-mono-num text-white">${formatNumber(clutchWin, 0)}%</p>
                                </div>
                                <div class="text-xs text-slate-400">
                                    ${p.clutches?.won || 0}/${p.clutches?.attempts || 0}
                                </div>
                            </div>

                            <!-- KAST -->
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-slate-400">KAST</p>
                                    <p class="text-xl font-semibold font-mono-num text-white">${formatNumber(kast, 0)}%</p>
                                </div>
                                ${getTierBadge(kast, [80, 70, 60], ['Elite', 'Good', 'Average', 'Low'])}
                            </div>

                            <!-- Utility Stats -->
                            <div class="pt-4 border-t border-slate-700">
                                <p class="text-sm text-slate-400 mb-2">Utility Usage</p>
                                <div class="grid grid-cols-2 gap-2 text-xs">
                                    <div class="bg-slate-700/50 rounded px-2 py-1">
                                        <span class="text-slate-400">Flashes:</span>
                                        <span class="font-mono-num ml-1">${p.utility?.flashbangs_thrown || 0}</span>
                                    </div>
                                    <div class="bg-slate-700/50 rounded px-2 py-1">
                                        <span class="text-slate-400">HE:</span>
                                        <span class="font-mono-num ml-1">${p.utility?.he_thrown || 0}</span>
                                    </div>
                                    <div class="bg-slate-700/50 rounded px-2 py-1">
                                        <span class="text-slate-400">Smokes:</span>
                                        <span class="font-mono-num ml-1">${p.utility?.smokes_thrown || 0}</span>
                                    </div>
                                    <div class="bg-slate-700/50 rounded px-2 py-1">
                                        <span class="text-slate-400">Molotovs:</span>
                                        <span class="font-mono-num ml-1">${p.utility?.molotovs_thrown || 0}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // =============================================================================
        // Render Compare Tab
        // =============================================================================
        function populatePlayerSelects() {
            const players = Object.values(currentMatchData.players || {});
            const selectA = document.getElementById('player-a-select');
            const selectB = document.getElementById('player-b-select');

            const options = players.map((p, i) =>
                `<option value="${i}">${escapeHtml(p.name || 'Unknown')} (${p.team || '?'})</option>`
            ).join('');

            selectA.innerHTML = options;
            selectB.innerHTML = options;

            // Select different players by default
            if (players.length >= 2) {
                selectB.selectedIndex = 1;
            }

            // Add change listeners
            selectA.addEventListener('change', renderCompare);
            selectB.addEventListener('change', renderCompare);
        }

        function renderCompare() {
            const players = Object.values(currentMatchData.players || {});
            const selectA = document.getElementById('player-a-select');
            const selectB = document.getElementById('player-b-select');

            if (players.length < 2) return;

            const playerA = players[selectA.selectedIndex];
            const playerB = players[selectB.selectedIndex];

            // Normalize values to 0-100 scale
            function normalize(value, min, max, inverse = false) {
                if (value === null || value === undefined) return 50;
                const clamped = Math.max(min, Math.min(max, value));
                const normalized = ((clamped - min) / (max - min)) * 100;
                return inverse ? 100 - normalized : normalized;
            }

            const metricsA = {
                adr: normalize(playerA.adr, 0, 130),
                hsPercent: playerA.headshot_percentage || 0,
                openingWin: playerA.opening_duels?.win_rate || 0,
                clutchWin: playerA.clutches?.win_rate || 0,
                kast: playerA.kast_percentage || 0,
                reflex: normalize(playerA.ttd_mean_ms || 400, 100, 600, true) // Inverse: lower TTD = higher score
            };

            const metricsB = {
                adr: normalize(playerB.adr, 0, 130),
                hsPercent: playerB.headshot_percentage || 0,
                openingWin: playerB.opening_duels?.win_rate || 0,
                clutchWin: playerB.clutches?.win_rate || 0,
                kast: playerB.kast_percentage || 0,
                reflex: normalize(playerB.ttd_mean_ms || 400, 100, 600, true)
            };

            // Update or create chart
            const ctx = document.getElementById('compare-chart').getContext('2d');

            const chartData = {
                labels: ['ADR', 'HS%', 'Opening Win', 'Clutch Win', 'KAST', 'Reflex'],
                datasets: [
                    {
                        label: playerA.name || 'Player A',
                        data: [metricsA.adr, metricsA.hsPercent, metricsA.openingWin, metricsA.clutchWin, metricsA.kast, metricsA.reflex],
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(59, 130, 246, 1)'
                    },
                    {
                        label: playerB.name || 'Player B',
                        data: [metricsB.adr, metricsB.hsPercent, metricsB.openingWin, metricsB.clutchWin, metricsB.kast, metricsB.reflex],
                        backgroundColor: 'rgba(234, 179, 8, 0.2)',
                        borderColor: 'rgba(234, 179, 8, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(234, 179, 8, 1)'
                    }
                ]
            };

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            stepSize: 20,
                            color: '#94a3b8',
                            backdropColor: 'transparent'
                        },
                        grid: {
                            color: '#334155'
                        },
                        angleLines: {
                            color: '#334155'
                        },
                        pointLabels: {
                            color: '#e2e8f0',
                            font: {
                                size: 12
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#e2e8f0',
                            padding: 20,
                            font: {
                                size: 12
                            }
                        }
                    }
                }
            };

            if (radarChart) {
                radarChart.data = chartData;
                radarChart.update();
            } else {
                radarChart = new Chart(ctx, {
                    type: 'radar',
                    data: chartData,
                    options: chartOptions
                });
            }

            // Render comparison stats
            const statsContainer = document.getElementById('comparison-stats');
            statsContainer.innerHTML = `
                <div class="bg-slate-700/50 rounded-lg p-4">
                    <h4 class="text-sm font-semibold text-blue-400 mb-3">${escapeHtml(playerA.name || 'Player A')}</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between"><span class="text-slate-400">K/D:</span> <span class="font-mono-num">${formatNumber(playerA.kd_ratio, 2)}</span></div>
                        <div class="flex justify-between"><span class="text-slate-400">ADR:</span> <span class="font-mono-num">${formatNumber(playerA.adr, 1)}</span></div>
                        <div class="flex justify-between"><span class="text-slate-400">Rating:</span> <span class="font-mono-num ${getRatingColor(playerA.hltv_rating)}">${formatNumber(playerA.hltv_rating, 2)}</span></div>
                        <div class="flex justify-between"><span class="text-slate-400">TTD:</span> <span class="font-mono-num">${playerA.ttd_mean_ms ? formatNumber(playerA.ttd_mean_ms, 0) + ' ms' : 'N/A'}</span></div>
                        <div class="flex justify-between"><span class="text-slate-400">CP:</span> <span class="font-mono-num">${playerA.cp_median_error_deg ? formatNumber(playerA.cp_median_error_deg, 1) + '°' : 'N/A'}</span></div>
                    </div>
                </div>
                <div class="bg-slate-700/50 rounded-lg p-4">
                    <h4 class="text-sm font-semibold text-yellow-400 mb-3">${escapeHtml(playerB.name || 'Player B')}</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between"><span class="text-slate-400">K/D:</span> <span class="font-mono-num">${formatNumber(playerB.kd_ratio, 2)}</span></div>
                        <div class="flex justify-between"><span class="text-slate-400">ADR:</span> <span class="font-mono-num">${formatNumber(playerB.adr, 1)}</span></div>
                        <div class="flex justify-between"><span class="text-slate-400">Rating:</span> <span class="font-mono-num ${getRatingColor(playerB.hltv_rating)}">${formatNumber(playerB.hltv_rating, 2)}</span></div>
                        <div class="flex justify-between"><span class="text-slate-400">TTD:</span> <span class="font-mono-num">${playerB.ttd_mean_ms ? formatNumber(playerB.ttd_mean_ms, 0) + ' ms' : 'N/A'}</span></div>
                        <div class="flex justify-between"><span class="text-slate-400">CP:</span> <span class="font-mono-num">${playerB.cp_median_error_deg ? formatNumber(playerB.cp_median_error_deg, 1) + '°' : 'N/A'}</span></div>
                    </div>
                </div>
            `;
        }

        // =============================================================================
        // Render Weapons Tab
        // =============================================================================
        function populateWeaponsSelect() {
            const players = Object.values(currentMatchData.players || {});
            const select = document.getElementById('weapons-player-select');

            const options = players.map((p, i) =>
                `<option value="${i}">${escapeHtml(p.name || 'Unknown')} (${p.team || '?'})</option>`
            ).join('');

            select.innerHTML = options;

            // Add change listener
            select.addEventListener('change', renderWeapons);

            // Initial render
            renderWeapons();
        }

        function getWeaponIcon(weapon) {
            // Map common weapon names to display names
            const weaponNames = {
                'ak47': 'AK-47',
                'm4a1': 'M4A1-S',
                'm4a4': 'M4A4',
                'm4a1_silencer': 'M4A1-S',
                'awp': 'AWP',
                'deagle': 'Desert Eagle',
                'usp_silencer': 'USP-S',
                'glock': 'Glock-18',
                'p250': 'P250',
                'fiveseven': 'Five-SeveN',
                'tec9': 'Tec-9',
                'cz75a': 'CZ75-Auto',
                'galil': 'Galil AR',
                'famas': 'FAMAS',
                'sg556': 'SG 553',
                'aug': 'AUG',
                'ssg08': 'SSG 08',
                'scar20': 'SCAR-20',
                'g3sg1': 'G3SG1',
                'nova': 'Nova',
                'xm1014': 'XM1014',
                'sawedoff': 'Sawed-Off',
                'mag7': 'MAG-7',
                'mac10': 'MAC-10',
                'mp9': 'MP9',
                'mp7': 'MP7',
                'ump45': 'UMP-45',
                'bizon': 'PP-Bizon',
                'p90': 'P90',
                'mp5sd': 'MP5-SD',
                'negev': 'Negev',
                'm249': 'm249',
                'knife': 'Knife',
                'knife_t': 'Knife',
                'knife_default_ct': 'Knife',
                'knife_default_t': 'Knife',
                'hegrenade': 'HE Grenade',
                'molotov': 'Molotov',
                'incgrenade': 'Incendiary',
                'inferno': 'Fire',
            };
            return weaponNames[weapon?.toLowerCase()] || weapon || 'Unknown';
        }

        function getWeaponCategory(weapon) {
            const rifles = ['ak47', 'm4a1', 'm4a4', 'm4a1_silencer', 'galil', 'famas', 'sg556', 'aug'];
            const snipers = ['awp', 'ssg08', 'scar20', 'g3sg1'];
            const pistols = ['deagle', 'usp_silencer', 'glock', 'p250', 'fiveseven', 'tec9', 'cz75a', 'p2000', 'hkp2000'];
            const smgs = ['mac10', 'mp9', 'mp7', 'ump45', 'bizon', 'p90', 'mp5sd'];
            const shotguns = ['nova', 'xm1014', 'sawedoff', 'mag7'];
            const heavy = ['negev', 'm249'];
            const utility = ['hegrenade', 'molotov', 'incgrenade', 'inferno'];
            const melee = ['knife', 'knife_t', 'knife_default_ct', 'knife_default_t'];

            const w = weapon?.toLowerCase();
            if (rifles.includes(w)) return 'rifle';
            if (snipers.includes(w)) return 'sniper';
            if (pistols.includes(w)) return 'pistol';
            if (smgs.includes(w)) return 'smg';
            if (shotguns.includes(w)) return 'shotgun';
            if (heavy.includes(w)) return 'heavy';
            if (utility.includes(w)) return 'utility';
            if (melee.includes(w)) return 'melee';
            return 'other';
        }

        function getCategoryBadge(category) {
            const badges = {
                'rifle': 'bg-blue-500/20 text-blue-400',
                'sniper': 'bg-purple-500/20 text-purple-400',
                'pistol': 'bg-green-500/20 text-green-400',
                'smg': 'bg-yellow-500/20 text-yellow-400',
                'shotgun': 'bg-orange-500/20 text-orange-400',
                'heavy': 'bg-red-500/20 text-red-400',
                'utility': 'bg-cyan-500/20 text-cyan-400',
                'melee': 'bg-slate-500/20 text-slate-400',
                'other': 'bg-slate-500/20 text-slate-400',
            };
            return badges[category] || badges['other'];
        }

        function renderWeapons() {
            const players = Object.values(currentMatchData.players || {});
            const select = document.getElementById('weapons-player-select');
            const tableBody = document.getElementById('weapons-table');
            const noDataDiv = document.getElementById('weapons-no-data');

            if (players.length === 0) {
                tableBody.innerHTML = '';
                noDataDiv.classList.remove('hidden');
                return;
            }

            const player = players[select.selectedIndex];
            const weapons = player.weapons || [];

            if (weapons.length === 0) {
                tableBody.innerHTML = '';
                noDataDiv.classList.remove('hidden');
                return;
            }

            noDataDiv.classList.add('hidden');

            tableBody.innerHTML = weapons.map((w, i) => {
                const category = getWeaponCategory(w.weapon);
                const categoryBadge = getCategoryBadge(category);
                const rowBg = i % 2 === 0 ? 'bg-slate-800' : 'bg-slate-800/50';

                // Accuracy color coding
                let accuracyClass = 'text-slate-400';
                if (w.accuracy > 0) {
                    if (w.accuracy >= 30) accuracyClass = 'text-green-400';
                    else if (w.accuracy >= 20) accuracyClass = 'text-yellow-400';
                    else accuracyClass = 'text-red-400';
                }

                // HS% color coding
                let hsClass = 'text-slate-400';
                if (w.headshot_pct > 0) {
                    if (w.headshot_pct >= 50) hsClass = 'text-green-400';
                    else if (w.headshot_pct >= 30) hsClass = 'text-yellow-400';
                }

                return `
                    <tr class="${rowBg} hover:bg-slate-700/50 transition-colors">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <span class="px-2 py-1 text-xs font-semibold rounded ${categoryBadge}">${category}</span>
                                <span class="font-medium text-white">${escapeHtml(getWeaponIcon(w.weapon))}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-center font-mono-num text-white font-semibold">${w.kills || 0}</td>
                        <td class="px-6 py-4 text-center font-mono-num ${hsClass}">${w.headshot_pct ? formatNumber(w.headshot_pct, 0) + '%' : 'N/A'}</td>
                        <td class="px-6 py-4 text-center font-mono-num">${w.damage || 0}</td>
                        <td class="px-6 py-4 text-center font-mono-num text-slate-400">${w.shots_fired || 0}</td>
                        <td class="px-6 py-4 text-center font-mono-num ${accuracyClass}">${w.accuracy ? formatNumber(w.accuracy, 1) + '%' : 'N/A'}</td>
                    </tr>
                `;
            }).join('');
        }
    </script>
</body>
</html>
