<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS2 Demo Analyzer - OpenSight</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for dark theme */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* Drop zone animation */
        .drop-zone-active {
            border-color: #3b82f6 !important;
            background-color: rgba(59, 130, 246, 0.1) !important;
        }

        /* Spinner animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }

        /* Tab transitions */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* Rating color classes */
        .rating-excellent { color: #22c55e; }
        .rating-good { color: #84cc16; }
        .rating-average { color: #eab308; }
        .rating-below { color: #f97316; }
        .rating-poor { color: #ef4444; }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 min-h-screen">
    <!-- Header -->
    <header class="bg-slate-800 border-b border-slate-700">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <h1 class="text-2xl font-bold text-white">CS2 Demo Analyzer</h1>
            <p class="text-slate-400 mt-1">Local analysis powered by awpy</p>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Upload Section -->
        <section id="upload-section" class="mb-8">
            <div
                id="drop-zone"
                class="border-2 border-dashed border-slate-600 rounded-lg p-12 text-center cursor-pointer hover:border-slate-500 hover:bg-slate-800/50 transition-all duration-200"
            >
                <div id="upload-content">
                    <svg class="mx-auto h-12 w-12 text-slate-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    <p class="text-lg text-slate-300 mb-2">Drop your demo file here</p>
                    <p class="text-sm text-slate-500 mb-4">or click to browse</p>
                    <p class="text-xs text-slate-600">Supports .dem and .dem.gz files up to 500MB</p>
                </div>
                <input type="file" id="file-input" class="hidden" accept=".dem,.dem.gz">
            </div>

            <!-- Progress Indicator -->
            <div id="progress-section" class="hidden mt-6">
                <div class="bg-slate-800 rounded-lg p-6 text-center">
                    <svg class="spinner mx-auto h-10 w-10 text-blue-500 mb-4" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p id="progress-text" class="text-slate-300">Uploading demo...</p>
                    <div class="mt-4 w-full bg-slate-700 rounded-full h-2">
                        <div id="progress-bar" class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <p id="progress-detail" class="text-sm text-slate-500 mt-2"></p>
                </div>
            </div>

            <!-- Error Message -->
            <div id="error-section" class="hidden mt-6">
                <div class="bg-red-900/30 border border-red-800 rounded-lg p-4">
                    <div class="flex items-start">
                        <svg class="h-5 w-5 text-red-500 mt-0.5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <div>
                            <h3 class="text-red-400 font-medium">Analysis Error</h3>
                            <p id="error-message" class="text-red-300 text-sm mt-1"></p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Results Section -->
        <section id="results-section" class="hidden">
            <!-- Tab Navigation -->
            <div class="flex border-b border-slate-700 mb-6">
                <button
                    id="tab-overview"
                    class="tab-btn px-6 py-3 text-sm font-medium border-b-2 border-blue-500 text-blue-400"
                    data-tab="overview"
                >
                    Overview
                </button>
                <button
                    id="tab-advanced"
                    class="tab-btn px-6 py-3 text-sm font-medium border-b-2 border-transparent text-slate-400 hover:text-slate-300"
                    data-tab="advanced"
                >
                    Advanced
                </button>
            </div>

            <!-- Overview Tab -->
            <div id="content-overview" class="tab-content active">
                <!-- Match Overview Card -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <div class="bg-slate-800 rounded-lg p-6">
                        <h3 class="text-slate-400 text-sm font-medium uppercase tracking-wider mb-3">Map</h3>
                        <p id="match-map" class="text-2xl font-bold text-white">-</p>
                    </div>
                    <div class="bg-slate-800 rounded-lg p-6">
                        <h3 class="text-slate-400 text-sm font-medium uppercase tracking-wider mb-3">Score</h3>
                        <p id="match-score" class="text-2xl font-bold text-white">-</p>
                    </div>
                    <div class="bg-slate-800 rounded-lg p-6">
                        <h3 class="text-slate-400 text-sm font-medium uppercase tracking-wider mb-3">Rounds</h3>
                        <p id="match-rounds" class="text-2xl font-bold text-white">-</p>
                    </div>
                </div>

                <!-- Match Info Row -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-slate-800 rounded-lg p-4">
                        <h4 class="text-slate-500 text-xs uppercase tracking-wider mb-1">Tick Rate</h4>
                        <p id="match-tickrate" class="text-lg font-semibold text-slate-200">-</p>
                    </div>
                    <div class="bg-slate-800 rounded-lg p-4">
                        <h4 class="text-slate-500 text-xs uppercase tracking-wider mb-1">Duration</h4>
                        <p id="match-duration" class="text-lg font-semibold text-slate-200">-</p>
                    </div>
                    <div class="bg-slate-800 rounded-lg p-4">
                        <h4 class="text-slate-500 text-xs uppercase tracking-wider mb-1">Total Kills</h4>
                        <p id="match-kills" class="text-lg font-semibold text-slate-200">-</p>
                    </div>
                    <div class="bg-slate-800 rounded-lg p-4">
                        <h4 class="text-slate-500 text-xs uppercase tracking-wider mb-1">MVP</h4>
                        <p id="match-mvp" class="text-lg font-semibold text-slate-200">-</p>
                    </div>
                </div>

                <!-- Players Table -->
                <div class="bg-slate-800 rounded-lg overflow-hidden">
                    <div class="px-6 py-4 border-b border-slate-700">
                        <h2 class="text-lg font-semibold text-white">Player Statistics</h2>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-700/50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Player</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-slate-400 uppercase tracking-wider">K</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-slate-400 uppercase tracking-wider">D</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-slate-400 uppercase tracking-wider">A</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-slate-400 uppercase tracking-wider">K/D</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-slate-400 uppercase tracking-wider">HS%</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-slate-400 uppercase tracking-wider">ADR</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-slate-400 uppercase tracking-wider">Rating</th>
                                </tr>
                            </thead>
                            <tbody id="players-table-body" class="divide-y divide-slate-700">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Advanced Tab -->
            <div id="content-advanced" class="tab-content">
                <!-- Advanced Metrics Table -->
                <div class="bg-slate-800 rounded-lg overflow-hidden">
                    <div class="px-6 py-4 border-b border-slate-700">
                        <h2 class="text-lg font-semibold text-white">Advanced Metrics</h2>
                        <p class="text-sm text-slate-400 mt-1">Time to Damage (TTD) and Crosshair Placement (CP) analysis</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-700/50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Player</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-slate-400 uppercase tracking-wider">ADR</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-slate-400 uppercase tracking-wider">KAST%</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-slate-400 uppercase tracking-wider">Mean TTD (ms)</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-slate-400 uppercase tracking-wider">Median CP (deg)</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-slate-400 uppercase tracking-wider">Aim Rating</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-slate-400 uppercase tracking-wider">Entry Rate</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-slate-400 uppercase tracking-wider">Utility</th>
                                </tr>
                            </thead>
                            <tbody id="advanced-table-body" class="divide-y divide-slate-700">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Metric Benchmarks -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div class="bg-slate-800 rounded-lg p-6">
                        <h3 class="text-white font-semibold mb-4">TTD Benchmarks</h3>
                        <ul class="space-y-2 text-sm">
                            <li class="flex justify-between"><span class="text-slate-400">Elite</span><span class="rating-excellent">&lt;200ms</span></li>
                            <li class="flex justify-between"><span class="text-slate-400">Good</span><span class="rating-good">200-350ms</span></li>
                            <li class="flex justify-between"><span class="text-slate-400">Average</span><span class="rating-average">350-500ms</span></li>
                            <li class="flex justify-between"><span class="text-slate-400">Slow</span><span class="rating-poor">&gt;500ms</span></li>
                        </ul>
                    </div>
                    <div class="bg-slate-800 rounded-lg p-6">
                        <h3 class="text-white font-semibold mb-4">Crosshair Placement Benchmarks</h3>
                        <ul class="space-y-2 text-sm">
                            <li class="flex justify-between"><span class="text-slate-400">Elite</span><span class="rating-excellent">&lt;5&deg;</span></li>
                            <li class="flex justify-between"><span class="text-slate-400">Good</span><span class="rating-good">5-15&deg;</span></li>
                            <li class="flex justify-between"><span class="text-slate-400">Average</span><span class="rating-average">15-25&deg;</span></li>
                            <li class="flex justify-between"><span class="text-slate-400">Needs Work</span><span class="rating-poor">&gt;25&deg;</span></li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-slate-800 border-t border-slate-700 mt-auto">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <p class="text-center text-sm text-slate-500">
                OpenSight - Professional-grade CS2 demo analysis
            </p>
        </div>
    </footer>

    <script>
        // DOM Elements
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const uploadContent = document.getElementById('upload-content');
        const progressSection = document.getElementById('progress-section');
        const progressText = document.getElementById('progress-text');
        const progressBar = document.getElementById('progress-bar');
        const progressDetail = document.getElementById('progress-detail');
        const errorSection = document.getElementById('error-section');
        const errorMessage = document.getElementById('error-message');
        const resultsSection = document.getElementById('results-section');
        const playersTableBody = document.getElementById('players-table-body');
        const advancedTableBody = document.getElementById('advanced-table-body');

        // XSS Protection
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }

        // Format numbers
        function formatNumber(num, decimals = 1) {
            if (num === null || num === undefined) return '-';
            return Number(num).toFixed(decimals);
        }

        // Get rating class based on HLTV rating
        function getRatingClass(rating) {
            if (rating >= 1.3) return 'rating-excellent';
            if (rating >= 1.1) return 'rating-good';
            if (rating >= 0.9) return 'rating-average';
            if (rating >= 0.7) return 'rating-below';
            return 'rating-poor';
        }

        // Get TTD rating class
        function getTtdClass(ttd) {
            if (ttd === null || ttd === undefined) return '';
            if (ttd < 200) return 'rating-excellent';
            if (ttd < 350) return 'rating-good';
            if (ttd < 500) return 'rating-average';
            return 'rating-poor';
        }

        // Get CP rating class
        function getCpClass(cp) {
            if (cp === null || cp === undefined) return '';
            if (cp < 5) return 'rating-excellent';
            if (cp < 15) return 'rating-good';
            if (cp < 25) return 'rating-average';
            return 'rating-poor';
        }

        // Tab Navigation
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.dataset.tab;

                // Update button states
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('border-blue-500', 'text-blue-400');
                    b.classList.add('border-transparent', 'text-slate-400');
                });
                btn.classList.remove('border-transparent', 'text-slate-400');
                btn.classList.add('border-blue-500', 'text-blue-400');

                // Show/hide content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`content-${tabId}`).classList.add('active');
            });
        });

        // File Input Handlers
        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drop-zone-active');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drop-zone-active');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drop-zone-active');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                handleFile(fileInput.files[0]);
            }
        });

        // Show/Hide UI States
        function showProgress() {
            progressSection.classList.remove('hidden');
            errorSection.classList.add('hidden');
            resultsSection.classList.add('hidden');
        }

        function showError(message) {
            progressSection.classList.add('hidden');
            errorSection.classList.remove('hidden');
            errorMessage.textContent = message;
        }

        function showResults() {
            progressSection.classList.add('hidden');
            errorSection.classList.add('hidden');
            resultsSection.classList.remove('hidden');
        }

        function updateProgress(text, percent, detail = '') {
            progressText.textContent = text;
            progressBar.style.width = `${percent}%`;
            progressDetail.textContent = detail;
        }

        // Poll for job status
        async function pollJobStatus(jobId) {
            const pollInterval = 1000; // 1 second
            const maxAttempts = 600; // 10 minutes max
            let attempts = 0;

            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(`/analyze/${jobId}`);
                    const data = await response.json();

                    if (data.status === 'completed') {
                        updateProgress('Analysis complete!', 100);
                        return data.result;
                    } else if (data.status === 'failed') {
                        throw new Error(data.error || 'Analysis failed');
                    } else if (data.status === 'processing') {
                        const progress = data.progress || 0;
                        updateProgress('Analyzing demo...', Math.max(10, progress), `${progress}% complete`);
                    } else {
                        updateProgress('Waiting in queue...', 5, 'Job queued');
                    }
                } catch (error) {
                    throw error;
                }

                await new Promise(resolve => setTimeout(resolve, pollInterval));
                attempts++;
            }

            throw new Error('Analysis timed out');
        }

        // Handle File Upload
        async function handleFile(file) {
            // Validate file
            const validExtensions = ['.dem', '.dem.gz'];
            const fileName = file.name.toLowerCase();
            const isValid = validExtensions.some(ext => fileName.endsWith(ext));

            if (!isValid) {
                showError('Invalid file type. Please upload a .dem or .dem.gz file.');
                return;
            }

            if (file.size > 500 * 1024 * 1024) {
                showError('File too large. Maximum size is 500MB.');
                return;
            }

            showProgress();
            updateProgress('Uploading demo...', 0, `${(file.size / 1024 / 1024).toFixed(1)} MB`);

            try {
                // Upload file
                const formData = new FormData();
                formData.append('file', file);

                const uploadResponse = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });

                if (!uploadResponse.ok) {
                    const errorData = await uploadResponse.json().catch(() => ({}));
                    throw new Error(errorData.detail || `Upload failed: ${uploadResponse.status}`);
                }

                const uploadResult = await uploadResponse.json();
                updateProgress('Processing demo...', 10, 'Job submitted');

                // Poll for results
                const result = await pollJobStatus(uploadResult.job_id);

                // Display results
                displayResults(result);
                showResults();

            } catch (error) {
                console.error('Analysis error:', error);
                showError(error.message || 'An unexpected error occurred');
            }
        }

        // Display Results
        function displayResults(data) {
            const demoInfo = data.demo_info || {};
            const players = data.players || {};

            // Match Overview
            document.getElementById('match-map').textContent = escapeHtml(demoInfo.map || 'Unknown');
            document.getElementById('match-score').textContent = escapeHtml(demoInfo.score || '-');
            document.getElementById('match-rounds').textContent = demoInfo.rounds || '-';
            document.getElementById('match-tickrate').textContent = demoInfo.tick_rate ? `${demoInfo.tick_rate} tick` : '-';
            document.getElementById('match-duration').textContent = demoInfo.duration_minutes ? `${formatNumber(demoInfo.duration_minutes, 1)} min` : '-';
            document.getElementById('match-kills').textContent = demoInfo.total_kills || '-';

            // MVP
            if (data.mvp) {
                document.getElementById('match-mvp').textContent = escapeHtml(data.mvp.name);
            } else {
                document.getElementById('match-mvp').textContent = '-';
            }

            // Convert players object to array and sort by rating
            const playerList = Object.entries(players).map(([steamId, player]) => ({
                steamId,
                ...player
            })).sort((a, b) => {
                const ratingA = a.rating?.hltv_rating || 0;
                const ratingB = b.rating?.hltv_rating || 0;
                return ratingB - ratingA;
            });

            // Populate Overview Table
            playersTableBody.innerHTML = playerList.map(player => {
                const stats = player.stats || {};
                const rating = player.rating || {};
                const ratingValue = rating.hltv_rating || 0;
                const ratingClass = getRatingClass(ratingValue);
                const teamClass = player.team === 'CT' ? 'text-blue-400' : 'text-yellow-400';

                return `
                    <tr class="hover:bg-slate-700/50">
                        <td class="px-4 py-3">
                            <div class="flex items-center">
                                <span class="${teamClass} font-medium mr-2">${escapeHtml(player.team || '')}</span>
                                <span class="text-white font-medium">${escapeHtml(player.name || 'Unknown')}</span>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-center text-slate-300">${stats.kills || 0}</td>
                        <td class="px-4 py-3 text-center text-slate-300">${stats.deaths || 0}</td>
                        <td class="px-4 py-3 text-center text-slate-300">${stats.assists || 0}</td>
                        <td class="px-4 py-3 text-center text-slate-300">${formatNumber(stats.kd_ratio, 2)}</td>
                        <td class="px-4 py-3 text-center text-slate-300">${formatNumber(stats.headshot_pct, 0)}%</td>
                        <td class="px-4 py-3 text-center text-slate-300">${formatNumber(stats.adr, 1)}</td>
                        <td class="px-4 py-3 text-center font-semibold ${ratingClass}">${formatNumber(ratingValue, 2)}</td>
                    </tr>
                `;
            }).join('');

            // Populate Advanced Table
            advancedTableBody.innerHTML = playerList.map(player => {
                const stats = player.stats || {};
                const rating = player.rating || {};
                const advanced = player.advanced || {};
                const utility = player.utility || {};

                const ttdValue = advanced.ttd_mean_ms;
                const cpValue = advanced.cp_median_error_deg;
                const ttdClass = getTtdClass(ttdValue);
                const cpClass = getCpClass(cpValue);
                const teamClass = player.team === 'CT' ? 'text-blue-400' : 'text-yellow-400';

                return `
                    <tr class="hover:bg-slate-700/50">
                        <td class="px-4 py-3">
                            <div class="flex items-center">
                                <span class="${teamClass} font-medium mr-2">${escapeHtml(player.team || '')}</span>
                                <span class="text-white font-medium">${escapeHtml(player.name || 'Unknown')}</span>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-center text-slate-300">${formatNumber(stats.adr, 1)}</td>
                        <td class="px-4 py-3 text-center text-slate-300">${formatNumber(rating.kast_percentage, 0)}%</td>
                        <td class="px-4 py-3 text-center ${ttdClass}">${ttdValue !== null && ttdValue !== undefined ? formatNumber(ttdValue, 0) : '-'}</td>
                        <td class="px-4 py-3 text-center ${cpClass}">${cpValue !== null && cpValue !== undefined ? formatNumber(cpValue, 1) + 'Â°' : '-'}</td>
                        <td class="px-4 py-3 text-center text-slate-300">${formatNumber(rating.aim_rating, 0)}</td>
                        <td class="px-4 py-3 text-center text-slate-300">${formatNumber(rating.entry_success_rate, 0)}%</td>
                        <td class="px-4 py-3 text-center text-slate-300">${formatNumber(rating.utility_rating, 0)}</td>
                    </tr>
                `;
            }).join('');
        }
    </script>
</body>
</html>
